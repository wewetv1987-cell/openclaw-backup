# MODEL_FALLBACK.md - æ¨¡å‹é™çº§ç­–ç•¥

> å½“ä¸»æ¨¡å‹ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨é™çº§åˆ°å¤‡ç”¨æ¨¡å‹ï¼Œé¿å…æ­»å¾ªç¯

---

## âš ï¸ é—®é¢˜åœºæ™¯

```
é”™è¯¯: All models failed
- zai/glm-5: rate_limit (å†·å´ä¸­)
- zai/glm-4.7-flash: rate_limit (å†·å´ä¸­)
- zai/glm-4.6v: rate_limit (å†·å´ä¸­)
- zai/glm-4.5: rate_limit (å†·å´ä¸­)

â†’ ç³»ç»Ÿé™·å…¥æ­»å¾ªç¯ï¼
```

---

## ğŸ”§ é™çº§ç­–ç•¥

### é™çº§é“¾ (æŒ‰é¡ºåºå°è¯•)

```
ç¬¬ä¸€å±‚: ä¸»åŠ›æ¨¡å‹ (GLM-5 ç³»åˆ—)
â”œâ”€â”€ zai/glm-5           (å¤æ‚ä»»åŠ¡)
â”œâ”€â”€ zai/glm-4.7-flash   (å¤‡ç”¨ï¼Œ2å¹¶å‘)
â””â”€â”€ zai/glm-4.6v        (è§†è§‰ä»»åŠ¡)

ç¬¬äºŒå±‚: å¿«é€Ÿæ¨¡å‹ (GLM-4.5 ç³»åˆ—)
â”œâ”€â”€ zai/glm-4.5         (å¿«é€Ÿå“åº”)
â”œâ”€â”€ zai/glm-4-flash     (æ›´å¿«é€Ÿ)
â””â”€â”€ zai/glm-4-air       (æœ€è½»é‡)

ç¬¬ä¸‰å±‚: ç¾éš¾æ¢å¤ (å…¶ä»–æä¾›å•†)
â”œâ”€â”€ anthropic/claude    (å¦‚æœé…ç½®)
â”œâ”€â”€ openai/gpt-4        (å¦‚æœé…ç½®)
â””â”€â”€ æœ¬åœ°æ¨¡å‹            (æœ€åçš„å¤‡é€‰)
```

---

## ğŸ“‹ ä»£ç†é™çº§é…ç½®

### GLM-5 é˜µè¥ (4ä»£ç†)

```json
{
  "model": {
    "primary": "zai/glm-5",
    "fallbacks": [
      "zai/glm-4.7-flash",
      "zai/glm-4.6v",
      "zai/glm-4.5",
      "zai/glm-4-flash",
      "zai/glm-4-air"
    ]
  }
}
```

**é€‚ç”¨ä»£ç†**: Architect, Coder, Researcher, Reviewer

---

### GLM-4.6V é˜µè¥ (1ä»£ç†)

```json
{
  "model": {
    "primary": "zai/glm-4.6v",
    "fallbacks": [
      "zai/glm-4.5",
      "zai/glm-4-flash",
      "zai/glm-4-air"
    ]
  }
}
```

**é€‚ç”¨ä»£ç†**: Analyst

---

### GLM-4.5 é˜µè¥ (2ä»£ç†)

```json
{
  "model": {
    "primary": "zai/glm-4.5",
    "fallbacks": [
      "zai/glm-4-flash",
      "zai/glm-4-air"
    ]
  }
}
```

**é€‚ç”¨ä»£ç†**: Main, Automator

---

## ğŸš¨ ç´§æ€¥æ¢å¤æµç¨‹

### å½“æ‰€æœ‰æ¨¡å‹å¤±è´¥æ—¶

```
1. ç­‰å¾… 30 ç§’ (è®©é€Ÿç‡é™åˆ¶é‡ç½®)

2. é‡è¯•æœ€è½»é‡æ¨¡å‹ (glm-4-air)

3. å¦‚æœä»ç„¶å¤±è´¥:
   - é€šçŸ¥ç”¨æˆ·: "æ‰€æœ‰æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨"
   - å»ºè®®: ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•
   - è®°å½•é”™è¯¯åˆ°æ—¥å¿—

4. ä¸è¦æ— é™å¾ªç¯ï¼
   - è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°: 3
   - è¶…è¿‡ååœæ­¢å¹¶æŠ¥å‘Š
```

---

## ğŸ’» ä»£ç å®ç°

### é”™è¯¯å¤„ç†ä¼ªä»£ç 

```python
async def call_with_fallback(task, agent):
    models = [
        agent.primary_model,
        *agent.fallback_models
    ]
    
    max_retries = 3
    retry_delay = 30  # seconds
    
    for attempt in range(max_retries):
        for model in models:
            try:
                result = await call_model(model, task)
                return result
            except RateLimitError:
                print(f"âš ï¸ {model} é€Ÿç‡é™åˆ¶ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...")
                continue
            except AuthError:
                print(f"âš ï¸ {model} è®¤è¯å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...")
                continue
        
        # æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥äº†
        if attempt < max_retries - 1:
            print(f"â³ ç­‰å¾… {retry_delay} ç§’åé‡è¯•...")
            await sleep(retry_delay)
            retry_delay *= 2  # æŒ‡æ•°é€€é¿
    
    # æœ€ç»ˆå¤±è´¥
    raise AllModelsFailedError(
        "æ‰€æœ‰æ¨¡å‹éƒ½ä¸å¯ç”¨ã€‚è¯·ç¨åé‡è¯•ã€‚"
    )
```

---

## ğŸ“Š ç›‘æ§ä¸å‘Šè­¦

### è®°å½•æ¨¡å‹ä½¿ç”¨æƒ…å†µ

```
æ¯æ¬¡è°ƒç”¨è®°å½•:
- æ—¶é—´æˆ³
- ä»£ç†åç§°
- æ¨¡å‹åç§°
- æˆåŠŸ/å¤±è´¥
- å“åº”æ—¶é—´
- é€Ÿç‡é™åˆ¶çŠ¶æ€

å‘Šè­¦é˜ˆå€¼:
- è¿ç»­3æ¬¡å¤±è´¥ â†’ è­¦å‘Š
- è¿ç»­10æ¬¡å¤±è´¥ â†’ ä¸¥é‡
- æ‰€æœ‰æ¨¡å‹å¤±è´¥ â†’ ç´§æ€¥
```

---

## âœ… æœ€ä½³å®è·µ

1. **ä¸è¦æ­»å¾ªç¯**
   - è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
   - ä½¿ç”¨æŒ‡æ•°é€€é¿

2. **ä¼˜é›…é™çº§**
   - ä»å¼ºæ¨¡å‹åˆ°å¼±æ¨¡å‹
   - ä¿æŒåŠŸèƒ½å¯ç”¨

3. **åŠæ—¶é€šçŸ¥**
   - å‘Šè¯‰ç”¨æˆ·å‘ç”Ÿäº†ä»€ä¹ˆ
   - æä¾›é¢„è®¡æ¢å¤æ—¶é—´

4. **è®°å½•æ—¥å¿—**
   - ä¾¿äºé—®é¢˜è¯Šæ–­
   - ä¼˜åŒ–æ¨¡å‹é€‰æ‹©

---

*æ›´æ–°æ—¶é—´: 2026-02-17 14:15 GMT+7*
